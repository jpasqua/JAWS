  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  <style>
    canvas {
      -moz-user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
  </style>
  <div style="width:75\%;">
    <canvas id="tempCanvas"></canvas>
  </div>

  <script>
    const Color_Temp = '%TEMP_CLR%'
    const Color_Avg = '%AVG_CLR%'
    const Num_MA_Samples = 10;

    function createOptions(theTitle) {
      return {
        responsive: true, title: { display: true, text: theTitle, fontSize:16 },
        chartArea: { backgroundColor: 'rgba(255, 255, 255, 0.4)' },
        scales: {
          xAxes: [{ display: true, scaleLabel: { display: true, labelString: 'Date' }, type: 'time' }],
          yAxes: [{ display: true, scaleLabel: { display: true, labelString: 'Value' } }]
        }
      }
    }
    function createDatasets() {
      return {
          datasets: [
            { label: 'Temperature', borderColor: Color_Temp, fill: false, lineTension: 0, data: [] },
            { label: 'Moving Average', borderColor: Color_Avg, fill: false, lineTension: 0, data: [] } ]
          }
    }

    var tempConfig = { type: 'line', data: createDatasets(), options: createOptions("Historical Temperature Data") };
    var isMetric = %USE_METRIC%

    function prepData(theConfig, root) {
      theConfig.data.datasets[0].data = [];
      theConfig.data.datasets[1].data = [];
      var sum = 0;
      var mean = 0;
      for (var i = 0; i < root.history.length; i++) {
        var timestamp = root.history[i].ts*1000
        var temperature = root.history[i].t;
        sum += temperature
        if (i >= Num_MA_Samples) { sum -= root.history[i-Num_MA_Samples].t; mean = sum/Num_MA_Samples; }
        else { mean = sum/(i+1); }
        if (!isMetric) {
          temperature = Math.round((temperature * 9/5 + 32)*10)/10
          mean =  Math.round((mean * 9/5 + 32)*10)/10
        }
        theConfig.data.datasets[0].data.push({x: timestamp, y: temperature})
        theConfig.data.datasets[1].data.push({x: timestamp, y: mean})
      }
    }  

    $.when(
      $.getJSON(
        "/getHistory",
        function(root) { prepData(tempConfig, root) })).then(function() {
          var ctx = document.getElementById('tempCanvas').getContext('2d');
          var hourChart = new Chart(ctx, tempConfig);
        }); 

  </script>